<!DOCTYPE html>
<html>
<head>
  <!--test-->  
    <title>DGIdb Search</title>
    <style>
        body { font-family: Arial, sans-serif}
        select, input, button { font-size: 16px; margin: 5px 0; }
        pre { background: #f4f4f4; padding: 10px; }
        .error { color: red; }
    </style>

    <!--For navbar-->
    <link rel="stylesheet" type="text/css" href="../static/nav.css" >
        <!--Google Fonts-->
    <link href="https://fonts.googleapis.com/css2?family=Caprasimo&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet">

</head>
<body>

    <nav>
        <a href="/" class="title">DGIT</a>
        <div class="menu container">
            <a href="/search" class="menu" >Search</a>
            <a href="/about" class="menu">About</a>
            <a href="/db" class="menu">Database</a>
            <a href="/contact" class="menu" >Contact</a>
        </div>
    </nav>

    <h1>Gene-Drug Interaction Search</h1>

    {% if error %}
    <p class="error">{{ error }}</p>
    {% endif %}

    <form method="POST" action="/search">
        <input type="text" name="query" placeholder="Enter gene or drug">

        <select name="type" required>
        <option value="" disabled
            {% if not (search_type if search_type is defined else request.form.get('type')) %}selected{% endif %}>
            Select type
        </option>
        <option value="gene"
            {% if (search_type if search_type is defined else request.form.get('type')) == 'gene' %}selected{% endif %}>
            Gene
        </option>
        <option value="drug"
            {% if (search_type if search_type is defined else request.form.get('type')) == 'drug' %}selected{% endif %}>
            Drug
        </option>
        <option value="protein"
            {% if (search_type if search_type is defined else request.form.get('type')) == 'protein' %}selected{% endif %}>
            Protein
        </option>
        </select>
        <button type="submit">Search</button>
    </form>

    {% if mdd_list %}
        <h3>Common MDD {{ 'Genes' if (search_type or request.form.get('type')) == 'gene' else 'Drugs' }}</h3>
        <div style="display:flex; flex-wrap:wrap; gap:.4rem; margin:.5rem 0;">
            {% for item in mdd_list %}
            <span style="border:1px solid #ddd; padding:.1rem .5rem; border-radius:999px;">{{ item }}</span>
            {% endfor %}
        </div>
    {% endif %}


    {% if results %}
        {% if not (rows and rows|length > 0) %}
            <h2>Results</h2>
        {% endif %}

        {% if rows and search_type == 'protein' %}
            <h2>Protein Results</h2>
            <table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse; width:100%;">
                <thead>
                <tr>
                    <th>Short Name</th>
                    <th>Protein</th>
                    <th>UniProt ID</th>
                    <th>Organism</th>
                    <th>Associated Genes</th>
                </tr>
                </thead>
                <tbody>
                {% for r in rows %}
                <tr>
                    <td>{{ r.protein_name or "â€”" }}</td>
                    <td>{{ r.description or "â€”" }}</td>
                    <td>{{ r.uniprot_id or "â€”" }}</td>
                    <td>{{ r.organism or "â€”" }}</td>
                    <td>{{ r.genes }}</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        {% endif %}


        {% if rows and rows|length > 0 and search_type != 'protein'%}
            <h2>Results</h2>
            <table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse; width:100%;">
                    <thead>
                    <tr>
                        <th>{{ rows[0].left_label }}</th>
                        <th>{{ rows[0].right_label }}</th>
                        <th>Types</th>
                        <th>Direction</th>
                        <th>Score</th>
                        <th>Sources</th>
                        <th>PMIDs</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for r in rows %}
                        <tr>
                        <td><strong>{{ r.left_name or 'â€”' }}</strong><br><small style="color:#666">{{ r.left_cid or '' }}</small></td>
                        <td><strong>{{ r.right_name or 'â€”' }}</strong><br><small style="color:#666">{{ r.right_cid or '' }}</small></td>
                        <td>{{ r.types }}</td>
                        <td>{{ r.directions }}</td>
                        <td>{{ r.score if r.score is not none else 'â€”' }}</td>
                        <td>{{ r.sources }}</td>
                        <td>{{ r.pmids }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

            <h2 style="margin-top:1.5rem;">Interaction Strength (Strength of Evidence of Interaction)</h2>
            
            <!--this is for the visualization of the interaction scores-->
            <div id="scroll-container"
                style="width:100%; overflow-x:auto; border:1px solid #ddd; padding:10px;">
                <canvas id="scoreChart" height="400"></canvas>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
                const scoreData = JSON.parse('{{ rows | tojson | safe }}');
                const labels = scoreData.map(r => r.right_name || r.left_name);
                const scores = scoreData.map(r => r.score || 0);

                const canvas = document.getElementById('scoreChart');
                const widthPerBar = 100;  //adjust spacing
                canvas.width = Math.max(800, labels.length * widthPerBar);

                const ctx = canvas.getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                    labels: labels,
                    datasets: [{
                        label: 'Interaction Score (0â€“10)',
                        data: scores,
                        backgroundColor: scores.map(s =>
                        s > 8 ? '#4caf50' : s > 5 ? '#ffb300' : '#e57373'
                        )
                    }]
                    },
                    options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 10 },
                        x: { ticks: { autoSkip: false, font: { size: 10 } } }
                    }
                    }
                });
            </script>




            {% elif (search_type or request.form.get('type')) and not mdd_list %}
                <p>No results.</p>
            {% endif %}

            <details style="margin-top:1rem;">
                <summary>Raw Response (debug)</summary>
                <pre>{{ results | tojson(indent=2) }}</pre>
            </details>
        {% endif %}
    <!-- AI Chatbot Toggle Button -->
<button id="aiToggleBtn" style="position:fixed;bottom:20px;right:20px;z-index:1000;padding:10px 15px;border-radius:50%;background:#4caf50;color:white;border:none;font-size:18px;cursor:pointer;">ðŸ’¬</button>

<!-- Floating AI Chat Panel -->
<div id="aiPanel" style="display:none;position:fixed;bottom:70px;right:20px;width:300px;height:400px;background:white;border:1px solid #ccc;border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,0.2);z-index:1000;flex-direction:column;overflow:hidden;">
    <div id="aiPanelHeader" style="background:#4caf50;color:white;padding:10px;font-weight:bold;border-top-left-radius:10px;border-top-right-radius:10px;">AI Assistant</div>
    <div id="aiPanelBody" style="flex:1;padding:10px;overflow-y:auto;background:#f9f9f9;"></div>
    <div id="aiInputContainer" style="display:flex;border-top:1px solid #ccc;">
        <input type="text" id="aiInput" placeholder="Ask something..." style="flex:1;padding:8px;border:none;border-radius:0 0 0 10px;">
        <button id="aiSend" style="padding:8px 12px;border:none;background:#4caf50;color:white;cursor:pointer;border-radius:0 0 10px 0;">Send</button>
    </div>
</div>

<!-- Include Markdown parser -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
    const aiToggleBtn = document.getElementById('aiToggleBtn');
    const aiPanel = document.getElementById('aiPanel');
    const aiInput = document.getElementById('aiInput');
    const aiSend = document.getElementById('aiSend');
    const aiBody = document.getElementById('aiPanelBody');

    // Toggle AI panel visibility
    aiToggleBtn.addEventListener('click', () => {
        aiPanel.style.display = aiPanel.style.display === 'flex' ? 'none' : 'flex';
        aiPanel.style.flexDirection = 'column';
    });

    // Append message to chat panel
    function appendMessage(text, sender='user') {
        const p = document.createElement('p');
        p.style.margin = '5px 0';
        if(sender === 'ai'){
            // Render Markdown for AI messages
            p.innerHTML = marked.parse(text);
            p.style.color = '#000';
        } else {
            p.textContent = text;
            p.style.fontWeight = 'bold';
            p.style.color = '#333';
        }
        aiBody.appendChild(p);
        aiBody.scrollTop = aiBody.scrollHeight;
    }

    // Send question to backend
    async function sendQuestion() {
        const question = aiInput.value.trim();
        if(!question) return;
        appendMessage("You: " + question, 'user');
        aiInput.value = '';

        try {
            const response = await fetch('/ask', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ question })
            });
            const data = await response.json();
            appendMessage("DGIT AI Assistant: " + data.answer, 'ai');
        } catch (err) {
            appendMessage("DGIT AI Assistant: Error contacting server.", 'ai');
        }
    }

    aiSend.addEventListener('click', sendQuestion);
    aiInput.addEventListener('keypress', (e) => {
        if(e.key === 'Enter') sendQuestion();
    });
</script>
</body>
</html>
