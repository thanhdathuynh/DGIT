<!DOCTYPE html>
<html>
<head>
    <title>Database DGIT</title>
    <link rel="stylesheet" type="text/css" href="../static/nav.css">
    <link rel="stylesheet" type="text/css" href="../static/db.css">
    <link rel="stylesheet" type="text/css" href="../static/search.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Caprasimo&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet">
</head>
<body>
    <nav>
        <a href="/" class="title">DGIT</a>
        <div class="menu container">
            <a href="/search" class="menu">Search</a>
            <a href="/about" class="menu">About</a>
            <a href="/db" class="menu">Database</a>
            <a href="/contact" class="menu">Contact</a>
        </div>
    </nav>

    <div class="page-container">
        <div class="hero-section">
            <h1 class="hero-title">Query Cache Database</h1>
            <p class="hero-subtitle">View and manage all cached search queries and interaction data</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Queries</div>
                <div class="stat-number" id="totalQueries">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Gene Searches</div>
                <div class="stat-number" id="geneSearches">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Drug Searches</div>
                <div class="stat-number" id="drugSearches">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Protein Searches</div>
                <div class="stat-number" id="proteinSearches">0</div>
            </div>
        </div>

        <div class="content-box">
            <div class="cache-controls">
                <div class="cache-filters">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="gene">Genes</button>
                    <button class="filter-btn" data-filter="drug">Drugs</button>
                    <button class="filter-btn" data-filter="protein">Proteins</button>
                </div>
                <div class="action-buttons">
                    <button class="export-btn" onclick="exportToCSV()">üì• Export CSV</button>
                    <button class="export-btn danger" onclick="clearCache()">üóëÔ∏è Clear Cache</button>
                </div>
            </div>

            <div class="results-controls">
                <div class="results-info">
                    <span id="resultCount">Showing 0 results</span>
                </div>
                <input class="table-filter" id="searchFilter" type="text" placeholder="Search queries..." aria-label="Search cache">
                <div class="pagination-controls">
                    <button id="prevBtn" class="pagination-btn">‚Üê Previous</button>
                    <select id="rowsPerPage" class="rows-per-page">
                        <option value="10">10 per page</option>
                        <option value="25">25 per page</option>
                        <option value="50">50 per page</option>
                        <option value="100">100 per page</option>
                    </select>
                    <span id="pageInfo">Page 1</span>
                    <button id="nextBtn" class="pagination-btn">Next ‚Üí</button>
                </div>
            </div>

            <div class="table-wrapper">
                <table class="cache-table">
                    <thead>
                        <tr>
                            <th data-sort="query">Query</th>
                            <th data-sort="type">Type</th>
                            <th data-sort="timestamp">Timestamp</th>
                            <th data-sort="results">Results</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="cacheTableBody">
                        <!-- Rows will be inserted here -->
                    </tbody>
                </table>
            </div>

            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-state-icon">üìä</div>
                <h3>No Cache History Yet</h3>
                <p>Start searching to build your query cache database</p>
            </div>
        </div>
    </div>

    <script>
        // Sample cache data - in production, this would come from your backend
        let cacheData = [
            {
                id: 1,
                query: "TP53",
                type: "gene",
                timestamp: new Date(Date.now() - 3600000).toISOString(),
                resultCount: 45,
                interactions: ["Cisplatin", "Doxorubicin", "Etoposide"]
            },
            {
                id: 2,
                query: "Fluoxetine",
                type: "drug",
                timestamp: new Date(Date.now() - 7200000).toISOString(),
                resultCount: 23,
                interactions: ["SLC6A4", "HTR2A", "CYP2D6"]
            },
            {
                id: 3,
                query: "BDNF",
                type: "gene",
                timestamp: new Date(Date.now() - 10800000).toISOString(),
                resultCount: 18,
                interactions: ["Ketamine", "Sertraline"]
            },
            {
                id: 4,
                query: "Dopamine receptor D2",
                type: "protein",
                timestamp: new Date(Date.now() - 14400000).toISOString(),
                resultCount: 67,
                interactions: ["Haloperidol", "Risperidone", "Olanzapine"]
            },
            {
                id: 5,
                query: "SLC6A4",
                type: "gene",
                timestamp: new Date(Date.now() - 18000000).toISOString(),
                resultCount: 31,
                interactions: ["Escitalopram", "Paroxetine"]
            },
            {
                id: 6,
                query: "Lithium",
                type: "drug",
                timestamp: new Date(Date.now() - 21600000).toISOString(),
                resultCount: 12,
                interactions: ["GSK3B", "INPP1"]
            }
        ];

        let filteredData = [...cacheData];
        let currentPage = 1;
        let rowsPerPage = 10;
        let currentFilter = 'all';
        let sortColumn = null;
        let sortDirection = 'desc';

        // Update statistics
        function updateStats() {
            document.getElementById('totalQueries').textContent = cacheData.length;
            document.getElementById('geneSearches').textContent = cacheData.filter(d => d.type === 'gene').length;
            document.getElementById('drugSearches').textContent = cacheData.filter(d => d.type === 'drug').length;
            document.getElementById('proteinSearches').textContent = cacheData.filter(d => d.type === 'protein').length;
        }

        // Format timestamp
        function formatTimestamp(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 60) return `${diffMins} min${diffMins !== 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
            return date.toLocaleDateString();
        }

        // Render table
        function renderTable() {
            const tbody = document.getElementById('cacheTableBody');
            const emptyState = document.getElementById('emptyState');
            
            if (filteredData.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                document.querySelector('.table-wrapper').style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            document.querySelector('.table-wrapper').style.display = 'block';

            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageData = filteredData.slice(start, end);

            tbody.innerHTML = pageData.map(item => `
                <tr>
                    <td><strong>${item.query}</strong></td>
                    <td><span class="query-badge badge-${item.type}">${item.type.toUpperCase()}</span></td>
                    <td class="timestamp">${formatTimestamp(item.timestamp)}</td>
                    <td><span class="result-count">${item.resultCount} results</span></td>
                    <td><button class="view-btn" onclick="viewDetails(${item.id})">View</button></td>
                </tr>
            `).join('');

            updatePagination();
        }

        // Update pagination controls
        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / rowsPerPage) || 1;
            document.getElementById('resultCount').textContent = `Showing ${filteredData.length} result${filteredData.length !== 1 ? 's' : ''}`;
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages;
        }

        // Filter functionality
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                currentFilter = btn.dataset.filter;
                filteredData = currentFilter === 'all' 
                    ? [...cacheData]
                    : cacheData.filter(item => item.type === currentFilter);
                
                currentPage = 1;
                renderTable();
            });
        });

        // Search functionality
        document.getElementById('searchFilter').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            filteredData = cacheData.filter(item => {
                const matchesFilter = currentFilter === 'all' || item.type === currentFilter;
                const matchesSearch = item.query.toLowerCase().includes(term) || 
                                    item.interactions.some(i => i.toLowerCase().includes(term));
                return matchesFilter && matchesSearch;
            });
            currentPage = 1;
            renderTable();
        });

        // Pagination controls
        document.getElementById('rowsPerPage').addEventListener('change', (e) => {
            rowsPerPage = parseInt(e.target.value);
            currentPage = 1;
            renderTable();
        });

        document.getElementById('prevBtn').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        });

        document.getElementById('nextBtn').addEventListener('click', () => {
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        });

        // Table sorting
        document.querySelectorAll('th[data-sort]').forEach(th => {
            th.addEventListener('click', () => {
                const column = th.dataset.sort;
                if (sortColumn === column) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = column;
                    sortDirection = 'desc';
                }

                filteredData.sort((a, b) => {
                    let valA, valB;
                    
                    switch(column) {
                        case 'query':
                            valA = a.query.toLowerCase();
                            valB = b.query.toLowerCase();
                            break;
                        case 'type':
                            valA = a.type;
                            valB = b.type;
                            break;
                        case 'timestamp':
                            valA = new Date(a.timestamp);
                            valB = new Date(b.timestamp);
                            break;
                        case 'results':
                            valA = a.resultCount;
                            valB = b.resultCount;
                            break;
                    }

                    if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                    if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                });

                renderTable();
            });
        });

        // View details function
        function viewDetails(id) {
            const item = cacheData.find(d => d.id === id);
            if (item) {
                window.location.href = `/search?query=${encodeURIComponent(item.query)}&type=${item.type}`;
            }
        }

        // Export to CSV
        function exportToCSV() {
            const headers = ['Query', 'Type', 'Timestamp', 'Result Count', 'Interactions'];
            const rows = filteredData.map(item => [
                item.query,
                item.type,
                item.timestamp,
                item.resultCount,
                item.interactions.join('; ')
            ]);

            const csv = [headers, ...rows]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dgit-cache-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Clear cache
        function clearCache() {
            if (confirm('Are you sure you want to clear all cache data? This cannot be undone.')) {
                cacheData = [];
                filteredData = [];
                updateStats();
                renderTable();
                alert('Cache cleared successfully!');
            }
        }

        // Initialize
        updateStats();
        renderTable();
    </script>
</body>
</html>