<!DOCTYPE html>
<html>
<head>
  <!--test-->  
    <title>DGIdb Search</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        select, input, button { font-size: 16px; margin: 5px 0; }
        pre { background: #f4f4f4; padding: 10px; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Gene-Drug Interaction Search</h1>

    {% if error %}
    <p class="error">{{ error }}</p>
    {% endif %}

    <form method="POST" action="/">
        <input type="text" name="query" placeholder="Enter gene or drug">

        <select name="type" required>
        <option value="" disabled
            {% if not (search_type if search_type is defined else request.form.get('type')) %}selected{% endif %}>
            Select type
        </option>
        <option value="gene"
            {% if (search_type if search_type is defined else request.form.get('type')) == 'gene' %}selected{% endif %}>
            Gene
        </option>
        <option value="drug"
            {% if (search_type if search_type is defined else request.form.get('type')) == 'drug' %}selected{% endif %}>
            Drug
        </option>
        <option value="protein"
            {% if (search_type if search_type is defined else request.form.get('type')) == 'protein' %}selected{% endif %}>
            Protein
        </option>
        </select>
        <button type="submit">Search</button>
    </form>

    {% if mdd_list %}
        <h3>Common MDD {{ 'Genes' if (search_type or request.form.get('type')) == 'gene' else 'Drugs' }}</h3>
        <div style="display:flex; flex-wrap:wrap; gap:.4rem; margin:.5rem 0;">
            {% for item in mdd_list %}
            <span style="border:1px solid #ddd; padding:.1rem .5rem; border-radius:999px;">{{ item }}</span>
            {% endfor %}
        </div>
    {% endif %}


    {% if results %}
        {% if not (rows and rows|length > 0) %}
            <h2>Results</h2>
        {% endif %}

        {% if rows and search_type == 'protein' %}
            <h2>Associated Genes</h2>
            <table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse; width:100%;">
                <thead>
                <tr>
                    <th>Short Name</th>
                    <th>Protein</th>
                    <th>UniProt ID</th>
                    <th>Organism</th>
                    <th>Associated Genes</th>
                </tr>
                </thead>
                <tbody>
                {% for r in rows %}
                <tr>
                    <td>{{ r.protein_name or "—" }}</td>
                    <td>{{ r.description or "—" }}</td>
                    <td>{{ r.uniprot_id or "—" }}</td>
                    <td>{{ r.organism or "—" }}</td>
                    <td>{{ r.genes }}</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        {% endif %}


        {% if rows and rows|length > 0 and search_type != 'protein'%}
            <h2>Results</h2>
            <table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse; width:100%;">
                    <thead>
                    <tr>
                        <th>{{ rows[0].left_label }}</th>
                        <th>{{ rows[0].right_label }}</th>
                        <th>Types</th>
                        <th>Direction</th>
                        <th>Score</th>
                        <th>Sources</th>
                        <th>PMIDs</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for r in rows %}
                        <tr>
                        <td><strong>{{ r.left_name or '—' }}</strong><br><small style="color:#666">{{ r.left_cid or '' }}</small></td>
                        <td><strong>{{ r.right_name or '—' }}</strong><br><small style="color:#666">{{ r.right_cid or '' }}</small></td>
                        <td>{{ r.types }}</td>
                        <td>{{ r.directions }}</td>
                        <td>{{ r.score if r.score is not none else '—' }}</td>
                        <td>{{ r.sources }}</td>
                        <td>{{ r.pmids }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

            <h2 style="margin-top:1.5rem;">Interaction Strength (Strength of Evidence of Interaction)</h2>
            
            <!--this is for the visualization of the interaction scores-->
            <div id="scroll-container"
                style="width:100%; overflow-x:auto; border:1px solid #ddd; padding:10px;">
                <canvas id="scoreChart" height="400"></canvas>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
                const scoreData = JSON.parse('{{ rows | tojson | safe }}');
                const labels = scoreData.map(r => r.right_name || r.left_name);
                const scores = scoreData.map(r => r.score || 0);

                const canvas = document.getElementById('scoreChart');
                const widthPerBar = 100;  //adjust spacing
                canvas.width = Math.max(800, labels.length * widthPerBar);

                const ctx = canvas.getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                    labels: labels,
                    datasets: [{
                        label: 'Interaction Score (0–10)',
                        data: scores,
                        backgroundColor: scores.map(s =>
                        s > 8 ? '#4caf50' : s > 5 ? '#ffb300' : '#e57373'
                        )
                    }]
                    },
                    options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 10 },
                        x: { ticks: { autoSkip: false, font: { size: 10 } } }
                    }
                    }
                });
            </script>




            {% elif (search_type or request.form.get('type')) and not mdd_list %}
                <p>No results.</p>
            {% endif %}

            <details style="margin-top:1rem;">
                <summary>Raw Response (debug)</summary>
                <pre>{{ results | tojson(indent=2) }}</pre>
            </details>
        {% endif %}
</body>
</html>
